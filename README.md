# Документация проекта123

## Первый запуск

Процесс первоначальной настройки базы данных и миграций:

1. Первый запуск в базе только таблицы Directus
2. Пушим таблицы приложения:
   ```bash
   npx prisma db push
   ```
   После этого в базе только таблицы приложения

3. Перезапускаем контейнер Directus, он заново записывает свои таблицы. Теперь в базе таблицы приложения и таблицы Directus с данными

4. Забираем из базы схемы Directus и свои таблицы:
   ```bash
   npx prisma db pull
   ```
   Появляется новая схема `introspected`, переименовываем её в `directus` и кладем в `models`

5. Переустанавливаем таблицы для синхронизации Prisma:
   ```bash
   npx prisma migrate reset
   ```
   Все таблицы пропадают из базы

6. Создаем базовую миграцию из схем приложения и Directus:
   ```bash
   npx prisma migrate dev
   ```
   На этом моменте в таблицах Directus нет данных

7. Удаляем все таблицы Directus из базы вручную. В базе остаются только таблицы приложения и служебная `prisma_migrations`
   
   > **Примечание:** можно через `db push` - перед этим нужно убрать из папки со схемами схему Directus, а потом вернуть

8. Перезапускаем сервис Directus, чтобы он пересоздал таблицы с первичными данными
   
   Теперь у нас есть базовая миграция с Directus + первичные данные для его запуска

## Автогенерация DTO

Генерация DTO с декораторами валидации и документации Swagger выполняется с помощью `prisma-generator-nestjs-dto`.

Для запуска генерации выполните:
```bash
npx prisma generate
```

## Защита роутов

Роуты закрываются декораторами `UserAuthGuard` и `PermissionsGuard`. 

`PermissionsGuard` делает запросы в базу за разрешениями из Directus, но не каждый раз - все эти запросы кэшируются с помощью `@nestjs/cache-manager` на 15 минут. Это оптимизация, чтобы не нагружать базу запросами.
